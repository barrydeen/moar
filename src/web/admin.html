<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOAR Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .preset-card { transition: all 0.2s ease; }
        .preset-card:hover { transform: translateY(-2px); }
        .preset-card.selected { ring: 2px; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen" x-cloak x-data="adminApp()" x-init="init()">

    <!-- Top Bar -->
    <header class="border-b border-gray-800 px-6 py-4 flex items-center justify-between">
        <h1 class="text-xl font-bold tracking-tight">MOAR Admin</h1>
        <button @click="logout()" class="text-sm text-gray-400 hover:text-white transition">Logout</button>
    </header>

    <!-- Restart Banner -->
    <div x-show="pendingRestart" class="bg-amber-900/50 border border-amber-700 text-amber-200 px-6 py-3 text-sm">
        Configuration saved. Restart MOAR to apply changes.
    </div>

    <!-- ==================== RELAY LIST VIEW ==================== -->
    <main x-show="currentView === 'list'" class="max-w-4xl mx-auto px-6 py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Relays</h2>
            <button @click="currentView = 'presets'" class="bg-white text-gray-900 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">
                Create New Relay
            </button>
        </div>

        <div class="grid gap-4">
            <template x-for="relay in relays" :key="relay.id">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-5">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-semibold text-white" x-text="relay.name"></h3>
                            <p class="text-sm text-gray-400 mt-1" x-text="relay.description || 'No description'"></p>
                        </div>
                    </div>
                    <div class="mt-3 mb-3">
                        <span class="inline-block bg-gray-800 text-gray-300 text-xs font-mono rounded-full px-3 py-1" x-text="'wss://' + relay.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></span>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-4">
                        <template x-if="relay.policy?.write?.require_auth">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">Write Auth</span>
                        </template>
                        <template x-if="relay.policy?.read?.require_auth">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">Read Auth</span>
                        </template>
                        <template x-if="relay.policy?.write?.allowed_pubkeys?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="relay.policy.write.allowed_pubkeys.length + ' write keys'"></span>
                        </template>
                        <template x-if="relay.policy?.write?.tagged_pubkeys?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="relay.policy.write.tagged_pubkeys.length + ' tagged keys'"></span>
                        </template>
                        <template x-if="relay.policy?.events?.allowed_kinds?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="'Kinds: ' + relay.policy.events.allowed_kinds.join(', ')"></span>
                        </template>
                        <template x-if="relay.policy?.rate_limit">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">Rate Limited</span>
                        </template>
                    </div>
                    <div class="flex gap-3">
                        <button @click="showEditForm(relay)" class="text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Edit</button>
                        <button @click="confirmDelete(relay)" class="text-sm text-red-400 hover:text-red-300 px-3 py-1.5 transition">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="relays.length === 0" class="text-center text-gray-500 py-12">
            No relays configured. Create one to get started.
        </div>
    </main>

    <!-- ==================== PRESET SELECTOR VIEW ==================== -->
    <main x-show="currentView === 'presets'" class="max-w-4xl mx-auto px-6 py-8">
        <button @click="currentView = 'list'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to relays
        </button>

        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">Create a Relay</h2>
            <p class="text-gray-400 text-sm">Choose a preset to get started quickly, or build from scratch.</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <!-- Public Relay -->
            <button @click="selectPreset('public')" class="preset-card bg-gray-900 border border-gray-800 hover:border-emerald-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center mb-4 group-hover:bg-emerald-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-emerald-400">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                        <ellipse cx="12" cy="12" rx="4" ry="10" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M2.5 9h19M2.5 15h19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Public Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Open to everyone. Anyone can read and write events. Great for public discourse.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-emerald-500/10 text-emerald-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Read</span>
                    <span class="bg-emerald-500/10 text-emerald-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Write</span>
                </div>
            </button>

            <!-- Private Relay -->
            <button @click="selectPreset('private')" class="preset-card bg-gray-900 border border-gray-800 hover:border-violet-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center mb-4 group-hover:bg-violet-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-violet-400">
                        <rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <circle cx="12" cy="16" r="1.5" fill="currentColor"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Private Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Locked down. Only approved pubkeys can read or write. For private communities.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-violet-500/10 text-violet-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Auth Read</span>
                    <span class="bg-violet-500/10 text-violet-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Auth Write</span>
                </div>
            </button>

            <!-- Outbox Relay -->
            <button @click="selectPreset('outbox')" class="preset-card bg-gray-900 border border-gray-800 hover:border-sky-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-sky-500/10 flex items-center justify-center mb-4 group-hover:bg-sky-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-sky-400">
                        <path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" transform="rotate(180 12 12)"/>
                        <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Outbox Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Your broadcast channel. Only you can write, but anyone can read your notes.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-sky-500/10 text-sky-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Read</span>
                    <span class="bg-sky-500/10 text-sky-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Restricted Write</span>
                </div>
            </button>

            <!-- Inbox Relay -->
            <button @click="selectPreset('inbox')" class="preset-card bg-gray-900 border border-gray-800 hover:border-amber-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center mb-4 group-hover:bg-amber-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-amber-400">
                        <path d="M4 4h16v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M4 4l8 7 8-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="18" cy="18" r="4" fill="currentColor" opacity="0.2"/>
                        <path d="M18 16v4m-2-2h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Inbox Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Receive mentions. Anyone can write if they tag your pubkey. Open read access.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-amber-500/10 text-amber-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Read</span>
                    <span class="bg-amber-500/10 text-amber-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Tagged Write</span>
                </div>
            </button>

            <!-- DM Relay -->
            <button @click="selectPreset('dm')" class="preset-card bg-gray-900 border border-gray-800 hover:border-rose-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-rose-500/10 flex items-center justify-center mb-4 group-hover:bg-rose-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-rose-400">
                        <path d="M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 0 1-4.255-.964L3 20l1.338-3.123C3.49 15.509 3 13.812 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M9 12h.01M12 12h.01M15 12h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="18" cy="5" r="3" fill="currentColor" opacity="0.3"/>
                        <path d="M17 5h2M18 4v2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">DM Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Private messages. Anyone can write if tagging you. Only approved keys can read with AUTH.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-rose-500/10 text-rose-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Auth Read</span>
                    <span class="bg-rose-500/10 text-rose-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Tagged Write</span>
                </div>
            </button>

            <!-- Advanced / Custom -->
            <button @click="showCreateForm()" class="preset-card bg-gray-900 border border-gray-800 border-dashed hover:border-gray-600 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-gray-800 flex items-center justify-center mb-4 group-hover:bg-gray-700 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-gray-400">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Advanced Setup</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Full control. Configure every policy option manually from scratch.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-gray-800 text-gray-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Custom</span>
                </div>
            </button>
        </div>
    </main>

    <!-- ==================== SIMPLE PRESET FORM VIEW ==================== -->
    <main x-show="currentView === 'simpleForm'" class="max-w-2xl mx-auto px-6 py-8">
        <button @click="currentView = 'presets'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to presets
        </button>

        <div class="mb-6">
            <h2 class="text-lg font-semibold" x-text="'Create ' + presetLabel(selectedPreset) + ' Relay'"></h2>
            <p class="text-sm text-gray-400 mt-1" x-text="presetDescription(selectedPreset)"></p>
        </div>

        <!-- Basic fields -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Relay ID</label>
                <input type="text" x-model="form.id" placeholder="e.g. public, my-outbox"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1">Alphanumeric, hyphens, underscores. Used in the config file.</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" x-model="form.name"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Description</label>
                <textarea x-model="form.description" rows="2"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600"></textarea>
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-1">Subdomain</label>
                <input type="text" x-model="form.subdomain" placeholder="e.g. outbox"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1" x-show="form.subdomain" x-text="'wss://' + form.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></p>
            </div>
        </div>

        <!-- Auto-fill db_path from subdomain -->
        <template x-effect="if (!editingRelay && form.subdomain && !form.db_path_manual) form.db_path = 'data/' + form.subdomain + '.mdb'"></template>

        <!-- Pubkeys section (shown for presets that need them) -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4" x-show="presetNeedsPubkeys(selectedPreset)">
            <h3 class="text-sm font-medium text-gray-400 mb-1" x-text="presetPubkeyLabel(selectedPreset)"></h3>
            <p class="text-xs text-gray-500 mb-3" x-text="presetPubkeyHint(selectedPreset)"></p>
            <div class="flex flex-wrap gap-1.5 mb-2">
                <template x-for="(item, index) in simpleFormPubkeys" :key="index">
                    <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                        <span x-text="item.length > 20 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                        <button @click="simpleFormPubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                    </span>
                </template>
            </div>
            <input type="text" placeholder="Enter npub or hex pubkey and press Enter"
                @keydown.enter.prevent="addSimplePubkey($event)"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
        </div>

        <!-- Error -->
        <div x-show="formError" class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4 text-sm" x-text="formError"></div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button @click="savePresetRelay()" class="bg-white text-gray-900 px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">Create Relay</button>
            <button @click="currentView = 'presets'" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
            <button @click="convertToAdvanced()" class="ml-auto text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Advanced Setup â†’</button>
        </div>
    </main>

    <!-- ==================== ADVANCED FORM VIEW ==================== -->
    <main x-show="currentView === 'form'" class="max-w-2xl mx-auto px-6 py-8">
        <button @click="editingRelay ? (currentView = 'list') : (currentView = 'presets')" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back
        </button>

        <h2 class="text-lg font-semibold mb-6" x-text="editingRelay ? 'Edit Relay' : 'Advanced Setup'"></h2>

        <!-- Basic Info -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Basic Info</h3>

            <template x-if="!editingRelay">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">ID</label>
                    <input type="text" x-model="form.id" placeholder="e.g. public, outbox, dms"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <p class="text-xs text-gray-500 mt-1">Alphanumeric, hyphens, underscores only. Cannot be changed later.</p>
                </div>
            </template>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" x-model="form.name" placeholder="My Relay"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Description</label>
                <textarea x-model="form.description" rows="2" placeholder="Optional description"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Subdomain</label>
                <input type="text" x-model="form.subdomain" placeholder="e.g. outbox"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1" x-show="form.subdomain" x-text="'wss://' + form.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></p>
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-1">DB Path</label>
                <input type="text" x-model="form.db_path" placeholder="data/relay.mdb"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>
        </div>

        <!-- Auto-fill db_path from subdomain -->
        <template x-effect="if (!editingRelay && form.subdomain && !form.db_path_manual) form.db_path = 'data/' + form.subdomain + '.mdb'"></template>

        <!-- Write Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Write Policy</h3>

            <div class="flex items-center justify-between mb-4">
                <span class="text-sm">Require Auth</span>
                <button @click="form.write_require_auth = !form.write_require_auth" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="form.write_require_auth ? 'bg-white' : 'bg-gray-700'">
                    <span class="inline-block h-4 w-4 rounded-full transition-transform" :class="form.write_require_auth ? 'translate-x-6 bg-gray-900' : 'translate-x-1 bg-gray-400'"></span>
                </button>
            </div>

            <div class="mb-4" x-data="tagInput()" x-init="items = form.write_allowed_pubkeys">
                <label class="block text-sm text-gray-400 mb-1">Allowed Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.write_allowed_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.write_allowed_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <input type="text" placeholder="Enter pubkey and press Enter" @keydown.enter.prevent="addTag($event, form.write_allowed_pubkeys)"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4" x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Blocked Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.write_blocked_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.write_blocked_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <input type="text" placeholder="Enter pubkey and press Enter" @keydown.enter.prevent="addTag($event, form.write_blocked_pubkeys)"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Tagged Pubkeys</label>
                <p class="text-xs text-gray-500 mb-2">If set, events must contain a <code class="bg-gray-800 px-1 rounded">p</code> tag referencing one of these pubkeys to be accepted.</p>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.write_tagged_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.write_tagged_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <input type="text" placeholder="Enter pubkey and press Enter" @keydown.enter.prevent="addTag($event, form.write_tagged_pubkeys)"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>
        </div>

        <!-- Read Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Read Policy</h3>

            <div class="flex items-center justify-between mb-4">
                <span class="text-sm">Require Auth</span>
                <button @click="form.read_require_auth = !form.read_require_auth" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="form.read_require_auth ? 'bg-white' : 'bg-gray-700'">
                    <span class="inline-block h-4 w-4 rounded-full transition-transform" :class="form.read_require_auth ? 'translate-x-6 bg-gray-900' : 'translate-x-1 bg-gray-400'"></span>
                </button>
            </div>

            <div x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Allowed Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.read_allowed_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.read_allowed_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <input type="text" placeholder="Enter pubkey and press Enter" @keydown.enter.prevent="addTag($event, form.read_allowed_pubkeys)"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>
        </div>

        <!-- Event Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Event Policy</h3>

            <div class="mb-4" x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Allowed Kinds</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.allowed_kinds" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item"></span>
                            <button @click="form.allowed_kinds.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <input type="number" placeholder="Enter kind number and press Enter" @keydown.enter.prevent="addNumTag($event, form.allowed_kinds)"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4" x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Blocked Kinds</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.blocked_kinds" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item"></span>
                            <button @click="form.blocked_kinds.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <input type="number" placeholder="Enter kind number and press Enter" @keydown.enter.prevent="addNumTag($event, form.blocked_kinds)"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Min PoW</label>
                    <input type="number" x-model.number="form.min_pow" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Max Content Length</label>
                    <input type="number" x-model.number="form.max_content_length" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Custom Home Page -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4" x-show="editingRelay">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-400">Custom Home Page</h3>
                <div class="flex items-center gap-2">
                    <button @click="previewPage()" x-show="form.page_html" class="text-xs text-gray-400 hover:text-white border border-gray-700 rounded px-2 py-1 transition">Preview</button>
                    <button @click="form.page_html ? deletePage() : null" x-show="form.page_html" class="text-xs text-red-400 hover:text-red-300 px-2 py-1 transition">Remove</button>
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-3">Custom HTML served when someone visits this relay's URL in a browser. Leave empty for the default page. You can also place a file at <code class="bg-gray-800 px-1 rounded">pages/<span x-text="form.id"></span>.html</code>.</p>
            <textarea x-model="form.page_html" rows="12" placeholder="<!DOCTYPE html>&#10;<html>&#10;  <head><title>My Relay</title></head>&#10;  <body>...</body>&#10;</html>"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600 font-mono" spellcheck="false"></textarea>
        </div>

        <!-- Rate Limits -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-6">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Rate Limits</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Writes/min</label>
                    <input type="number" x-model.number="form.writes_per_minute" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Reads/min</label>
                    <input type="number" x-model.number="form.reads_per_minute" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Error message -->
        <div x-show="formError" class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4 text-sm" x-text="formError"></div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button @click="saveRelay()" class="bg-white text-gray-900 px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">Save</button>
            <button @click="editingRelay ? (currentView = 'list') : (currentView = 'presets')" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
            <template x-if="editingRelay">
                <button @click="confirmDelete(editingRelay)" class="ml-auto text-sm text-red-400 hover:text-red-300 px-4 py-2 transition">Delete</button>
            </template>
        </div>
    </main>

    <!-- ==================== DELETE MODAL ==================== -->
    <div x-show="deleteTarget" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
        <div class="absolute inset-0 bg-black/50" @click="deleteTarget = null"></div>
        <div class="relative bg-gray-900 border border-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-2">Delete Relay</h3>
            <p class="text-sm text-gray-400 mb-6">Are you sure you want to delete <span class="text-white font-medium" x-text="deleteTarget?.name"></span>? This cannot be undone.</p>
            <div class="flex gap-3 justify-end">
                <button @click="deleteTarget = null" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
                <button @click="deleteRelay()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <script>
        function tagInput() {
            return {
                addTag(event, arr) {
                    const val = event.target.value.trim();
                    if (val && !arr.includes(val)) {
                        arr.push(val);
                    }
                    event.target.value = '';
                },
                addNumTag(event, arr) {
                    const val = parseInt(event.target.value);
                    if (!isNaN(val) && !arr.includes(val)) {
                        arr.push(val);
                    }
                    event.target.value = '';
                }
            };
        }

        function adminApp() {
            return {
                relays: [],
                currentView: 'list',
                editingRelay: null,
                deleteTarget: null,
                pendingRestart: false,
                formError: '',
                selectedPreset: null,
                simpleFormPubkeys: [],
                statusInfo: { domain: 'localhost', port: 8080 },
                form: {
                    id: '',
                    name: '',
                    description: '',
                    subdomain: '',
                    db_path: '',
                    db_path_manual: false,
                    write_require_auth: false,
                    write_allowed_pubkeys: [],
                    write_blocked_pubkeys: [],
                    write_tagged_pubkeys: [],
                    read_require_auth: false,
                    read_allowed_pubkeys: [],
                    allowed_kinds: [],
                    blocked_kinds: [],
                    min_pow: '',
                    max_content_length: '',
                    writes_per_minute: '',
                    reads_per_minute: '',
                    page_html: '',
                },

                emptyForm() {
                    return {
                        id: '',
                        name: '',
                        description: '',
                        subdomain: '',
                        db_path: '',
                        db_path_manual: false,
                        write_require_auth: false,
                        write_allowed_pubkeys: [],
                        write_blocked_pubkeys: [],
                        write_tagged_pubkeys: [],
                        read_require_auth: false,
                        read_allowed_pubkeys: [],
                        allowed_kinds: [],
                        blocked_kinds: [],
                        min_pow: '',
                        max_content_length: '',
                        writes_per_minute: '',
                        reads_per_minute: '',
                        page_html: '',
                    };
                },

                // ---- Preset helpers ----

                presetLabel(p) {
                    return { public: 'Public', private: 'Private', outbox: 'Outbox', inbox: 'Inbox', dm: 'DM' }[p] || '';
                },

                presetDescription(p) {
                    const descs = {
                        public: 'An open relay where anyone can read and write. No authentication required.',
                        private: 'A members-only relay. Add the pubkeys that should have access.',
                        outbox: 'Your personal broadcast. Only your pubkeys can write, but anyone can read.',
                        inbox: 'Receive mentions and replies. Anyone can write events that tag your pubkeys.',
                        dm: 'Private messaging. Anyone can send DMs tagging your pubkeys, but only approved keys can read.',
                    };
                    return descs[p] || '';
                },

                presetNeedsPubkeys(p) {
                    return ['private', 'outbox', 'inbox', 'dm'].includes(p);
                },

                presetPubkeyLabel(p) {
                    const labels = {
                        private: 'Approved Pubkeys',
                        outbox: 'Writer Pubkeys',
                        inbox: 'Your Pubkeys (to be tagged)',
                        dm: 'Your Pubkeys (to be tagged & read)',
                    };
                    return labels[p] || 'Pubkeys';
                },

                presetPubkeyHint(p) {
                    const hints = {
                        private: 'These pubkeys will be able to read and write to this relay.',
                        outbox: 'Only these pubkeys will be allowed to publish events.',
                        inbox: 'Events must tag one of these pubkeys to be accepted. Anyone can read.',
                        dm: 'Events must tag one of these pubkeys to be accepted. Only these pubkeys can read (with AUTH).',
                    };
                    return hints[p] || '';
                },

                selectPreset(preset) {
                    this.selectedPreset = preset;
                    this.simpleFormPubkeys = [];
                    this.formError = '';

                    const defaults = {
                        public:  { name: 'Public Relay', description: 'A fully open relay', subdomain: 'pub' },
                        private: { name: 'Private Relay', description: 'Members only', subdomain: 'private' },
                        outbox:  { name: 'My Outbox', description: 'Only I can post here', subdomain: 'outbox' },
                        inbox:   { name: 'Inbox', description: 'Receive mentions and replies', subdomain: 'inbox' },
                        dm:      { name: 'DM Relay', description: 'Private direct messages', subdomain: 'dm' },
                    };

                    const d = defaults[preset];
                    this.form = this.emptyForm();
                    this.form.id = preset;
                    this.form.name = d.name;
                    this.form.description = d.description;
                    this.form.subdomain = d.subdomain;
                    this.form.db_path = 'data/' + d.subdomain + '.mdb';

                    this.currentView = 'simpleForm';
                },

                addSimplePubkey(event) {
                    const val = event.target.value.trim();
                    if (val && !this.simpleFormPubkeys.includes(val)) {
                        this.simpleFormPubkeys.push(val);
                    }
                    event.target.value = '';
                },

                applyPresetPolicy() {
                    const keys = [...this.simpleFormPubkeys];
                    const p = this.selectedPreset;

                    if (p === 'public') {
                        // No restrictions
                    } else if (p === 'private') {
                        this.form.write_require_auth = true;
                        this.form.write_allowed_pubkeys = [...keys];
                        this.form.read_require_auth = true;
                        this.form.read_allowed_pubkeys = [...keys];
                    } else if (p === 'outbox') {
                        this.form.write_allowed_pubkeys = [...keys];
                    } else if (p === 'inbox') {
                        this.form.write_tagged_pubkeys = [...keys];
                    } else if (p === 'dm') {
                        this.form.write_tagged_pubkeys = [...keys];
                        this.form.read_require_auth = true;
                        this.form.read_allowed_pubkeys = [...keys];
                        this.form.allowed_kinds = [4, 1059, 5];
                    }
                },

                async savePresetRelay() {
                    this.formError = '';
                    if (this.presetNeedsPubkeys(this.selectedPreset) && this.simpleFormPubkeys.length === 0) {
                        this.formError = 'Add at least one pubkey.';
                        return;
                    }
                    this.applyPresetPolicy();
                    await this.saveRelay();
                },

                convertToAdvanced() {
                    this.applyPresetPolicy();
                    this.editingRelay = null;
                    this.currentView = 'form';
                },

                // ---- Core CRUD ----

                async init() {
                    await this.fetchStatus();
                    await this.fetchRelays();
                },

                async fetchStatus() {
                    try {
                        const res = await fetch('/api/status');
                        if (res.ok) {
                            const data = await res.json();
                            this.pendingRestart = data.pending_restart;
                            this.statusInfo = { domain: data.domain, port: data.port };
                        }
                    } catch (e) { console.error('Failed to fetch status', e); }
                },

                async fetchRelays() {
                    try {
                        const res = await fetch('/api/relays');
                        if (res.ok) {
                            this.relays = await res.json();
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        }
                    } catch (e) { console.error('Failed to fetch relays', e); }
                },

                showCreateForm() {
                    this.editingRelay = null;
                    this.form = this.emptyForm();
                    this.formError = '';
                    this.currentView = 'form';
                },

                async showEditForm(relay) {
                    this.editingRelay = relay;
                    this.formError = '';
                    const p = relay.policy || {};
                    const w = p.write || {};
                    const r = p.read || {};
                    const e = p.events || {};
                    const rl = p.rate_limit || {};
                    this.form = {
                        id: relay.id,
                        name: relay.name,
                        description: relay.description || '',
                        subdomain: relay.subdomain,
                        db_path: relay.db_path,
                        db_path_manual: true,
                        write_require_auth: w.require_auth || false,
                        write_allowed_pubkeys: [...(w.allowed_pubkeys || [])],
                        write_blocked_pubkeys: [...(w.blocked_pubkeys || [])],
                        write_tagged_pubkeys: [...(w.tagged_pubkeys || [])],
                        read_require_auth: r.require_auth || false,
                        read_allowed_pubkeys: [...(r.allowed_pubkeys || [])],
                        allowed_kinds: [...(e.allowed_kinds || [])],
                        blocked_kinds: [...(e.blocked_kinds || [])],
                        min_pow: e.min_pow ?? '',
                        max_content_length: e.max_content_length ?? '',
                        writes_per_minute: rl.writes_per_minute ?? '',
                        reads_per_minute: rl.reads_per_minute ?? '',
                        page_html: '',
                    };
                    try {
                        const res = await fetch(`/api/relays/${relay.id}/page`);
                        if (res.ok) {
                            const data = await res.json();
                            this.form.page_html = data.html || '';
                        }
                    } catch (e) { console.error('Failed to fetch page', e); }
                    this.currentView = 'form';
                },

                collectFormData() {
                    const data = {
                        name: this.form.name,
                        description: this.form.description || null,
                        subdomain: this.form.subdomain,
                        db_path: this.form.db_path,
                        policy: {
                            write: {
                                require_auth: this.form.write_require_auth,
                                allowed_pubkeys: this.form.write_allowed_pubkeys.length ? this.form.write_allowed_pubkeys : null,
                                blocked_pubkeys: this.form.write_blocked_pubkeys.length ? this.form.write_blocked_pubkeys : null,
                                tagged_pubkeys: this.form.write_tagged_pubkeys.length ? this.form.write_tagged_pubkeys : null,
                            },
                            read: {
                                require_auth: this.form.read_require_auth,
                                allowed_pubkeys: this.form.read_allowed_pubkeys.length ? this.form.read_allowed_pubkeys : null,
                            },
                            events: {
                                allowed_kinds: this.form.allowed_kinds.length ? this.form.allowed_kinds : null,
                                blocked_kinds: this.form.blocked_kinds.length ? this.form.blocked_kinds : null,
                                min_pow: this.form.min_pow !== '' ? Number(this.form.min_pow) : null,
                                max_content_length: this.form.max_content_length !== '' ? Number(this.form.max_content_length) : null,
                            },
                            rate_limit: (this.form.writes_per_minute !== '' || this.form.reads_per_minute !== '') ? {
                                writes_per_minute: this.form.writes_per_minute !== '' ? Number(this.form.writes_per_minute) : null,
                                reads_per_minute: this.form.reads_per_minute !== '' ? Number(this.form.reads_per_minute) : null,
                            } : null,
                        }
                    };
                    if (!this.editingRelay) {
                        data.id = this.form.id;
                    }
                    return data;
                },

                async saveRelay() {
                    this.formError = '';
                    const data = this.collectFormData();

                    try {
                        let res;
                        if (this.editingRelay) {
                            res = await fetch(`/api/relays/${this.editingRelay.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });
                        } else {
                            res = await fetch('/api/relays', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });
                        }

                        if (res.ok) {
                            const relayId = this.editingRelay ? this.editingRelay.id : this.form.id;
                            if (this.form.page_html) {
                                await fetch(`/api/relays/${relayId}/page`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ html: this.form.page_html }),
                                });
                            } else if (this.editingRelay) {
                                await fetch(`/api/relays/${relayId}/page`, { method: 'DELETE' });
                            }
                            await this.fetchRelays();
                            await this.fetchStatus();
                            this.currentView = 'list';
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            this.formError = await res.text();
                        }
                    } catch (e) {
                        this.formError = 'Network error: ' + e.message;
                    }
                },

                confirmDelete(relay) {
                    this.deleteTarget = relay;
                },

                async deleteRelay() {
                    if (!this.deleteTarget) return;
                    try {
                        const res = await fetch(`/api/relays/${this.deleteTarget.id}`, { method: 'DELETE' });
                        if (res.ok || res.status === 204) {
                            this.deleteTarget = null;
                            await this.fetchRelays();
                            await this.fetchStatus();
                            if (this.currentView === 'form') {
                                this.currentView = 'list';
                            }
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            alert('Delete failed: ' + await res.text());
                        }
                    } catch (e) {
                        alert('Network error: ' + e.message);
                    }
                },

                previewPage() {
                    const win = window.open('', '_blank');
                    win.document.write(this.form.page_html);
                    win.document.close();
                },

                async deletePage() {
                    if (!this.editingRelay) return;
                    await fetch(`/api/relays/${this.editingRelay.id}/page`, { method: 'DELETE' });
                    this.form.page_html = '';
                },

                async logout() {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/';
                }
            };
        }
    </script>
</body>
</html>
