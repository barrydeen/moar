<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOAR Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .preset-card { transition: all 0.2s ease; }
        .preset-card:hover { transform: translateY(-2px); }
        .preset-card.selected { ring: 2px; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen" x-cloak x-data="adminApp()" x-init="init()">

    <!-- Top Bar -->
    <header class="border-b border-gray-800 px-6 py-4 flex items-center justify-between">
        <h1 class="text-xl font-bold tracking-tight">MOAR Admin</h1>
        <button @click="logout()" class="text-sm text-gray-400 hover:text-white transition">Logout</button>
    </header>

    <!-- Restart Banner -->
    <div x-show="pendingRestart" class="bg-amber-900/50 border border-amber-700 text-amber-200 px-6 py-3 text-sm">
        Configuration saved. Restart MOAR to apply changes.
    </div>

    <!-- Tab Navigation -->
    <nav x-show="currentView === 'list' || currentView === 'wotList' || currentView === 'blossomList'" class="max-w-4xl mx-auto px-6 pt-6">
        <div class="flex gap-1 border-b border-gray-800">
            <button @click="currentView = 'list'" class="px-4 py-2 text-sm font-medium border-b-2 transition" :class="currentView === 'list' ? 'border-white text-white' : 'border-transparent text-gray-400 hover:text-white'">Relays</button>
            <button @click="currentView = 'blossomList'; fetchBlossoms()" class="px-4 py-2 text-sm font-medium border-b-2 transition" :class="currentView === 'blossomList' ? 'border-white text-white' : 'border-transparent text-gray-400 hover:text-white'">Blossom</button>
            <button @click="currentView = 'wotList'; fetchWots()" class="px-4 py-2 text-sm font-medium border-b-2 transition" :class="currentView === 'wotList' ? 'border-white text-white' : 'border-transparent text-gray-400 hover:text-white'">Web of Trust</button>
        </div>
    </nav>

    <!-- ==================== RELAY LIST VIEW ==================== -->
    <main x-show="currentView === 'list'" class="max-w-4xl mx-auto px-6 py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Relays</h2>
            <button @click="currentView = 'presets'" class="bg-white text-gray-900 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">
                Create New Relay
            </button>
        </div>

        <div class="grid gap-4">
            <template x-for="relay in relays" :key="relay.id">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-5">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-semibold text-white" x-text="relay.name"></h3>
                            <p class="text-sm text-gray-400 mt-1" x-text="relay.description || 'No description'"></p>
                        </div>
                    </div>
                    <div class="mt-3 mb-3">
                        <span class="inline-block bg-gray-800 text-gray-300 text-xs font-mono rounded-full px-3 py-1" x-text="'wss://' + relay.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></span>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-4">
                        <template x-if="relay.policy?.write?.require_auth">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">Write Auth</span>
                        </template>
                        <template x-if="relay.policy?.read?.require_auth">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">Read Auth</span>
                        </template>
                        <template x-if="relay.policy?.write?.allowed_pubkeys?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="relay.policy.write.allowed_pubkeys.length + ' write keys'"></span>
                        </template>
                        <template x-if="relay.policy?.write?.tagged_pubkeys?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="relay.policy.write.tagged_pubkeys.length + ' tagged keys'"></span>
                        </template>
                        <template x-if="relay.policy?.events?.allowed_kinds?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="'Kinds: ' + relay.policy.events.allowed_kinds.join(', ')"></span>
                        </template>
                        <template x-if="relay.policy?.write?.wot">
                            <span class="bg-cyan-500/10 text-cyan-400 rounded-full px-2 py-1 text-xs" x-text="'Write WoT: ' + relay.policy.write.wot"></span>
                        </template>
                        <template x-if="relay.policy?.read?.wot">
                            <span class="bg-cyan-500/10 text-cyan-400 rounded-full px-2 py-1 text-xs" x-text="'Read WoT: ' + relay.policy.read.wot"></span>
                        </template>
                        <template x-if="relay.policy?.rate_limit">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">Rate Limited</span>
                        </template>
                    </div>
                    <div class="flex gap-3">
                        <button @click="showEditForm(relay)" class="text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Edit</button>
                        <button @click="confirmDelete(relay)" class="text-sm text-red-400 hover:text-red-300 px-3 py-1.5 transition">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="relays.length === 0" class="text-center text-gray-500 py-12">
            No relays configured. Create one to get started.
        </div>
    </main>

    <!-- ==================== PRESET SELECTOR VIEW ==================== -->
    <main x-show="currentView === 'presets'" class="max-w-4xl mx-auto px-6 py-8">
        <button @click="currentView = 'list'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to relays
        </button>

        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold mb-2">Create a Relay</h2>
            <p class="text-gray-400 text-sm">Choose a preset to get started quickly, or build from scratch.</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <!-- Public Relay -->
            <button @click="selectPreset('public')" class="preset-card bg-gray-900 border border-gray-800 hover:border-emerald-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center mb-4 group-hover:bg-emerald-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-emerald-400">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                        <ellipse cx="12" cy="12" rx="4" ry="10" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M2.5 9h19M2.5 15h19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Public Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Open to everyone. Anyone can read and write events. Great for public discourse.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-emerald-500/10 text-emerald-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Read</span>
                    <span class="bg-emerald-500/10 text-emerald-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Write</span>
                </div>
            </button>

            <!-- Private Relay -->
            <button @click="selectPreset('private')" class="preset-card bg-gray-900 border border-gray-800 hover:border-violet-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-violet-500/10 flex items-center justify-center mb-4 group-hover:bg-violet-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-violet-400">
                        <rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <circle cx="12" cy="16" r="1.5" fill="currentColor"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Private Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Locked down. Only approved pubkeys can read or write. For private communities.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-violet-500/10 text-violet-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Auth Read</span>
                    <span class="bg-violet-500/10 text-violet-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Auth Write</span>
                </div>
            </button>

            <!-- Outbox Relay -->
            <button @click="selectPreset('outbox')" class="preset-card bg-gray-900 border border-gray-800 hover:border-sky-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-sky-500/10 flex items-center justify-center mb-4 group-hover:bg-sky-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-sky-400">
                        <path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" transform="rotate(180 12 12)"/>
                        <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Outbox Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Your broadcast channel. Only you can write, but anyone can read your notes.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-sky-500/10 text-sky-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Read</span>
                    <span class="bg-sky-500/10 text-sky-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Restricted Write</span>
                </div>
            </button>

            <!-- Inbox Relay -->
            <button @click="selectPreset('inbox')" class="preset-card bg-gray-900 border border-gray-800 hover:border-amber-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center mb-4 group-hover:bg-amber-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-amber-400">
                        <path d="M4 4h16v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M4 4l8 7 8-7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="18" cy="18" r="4" fill="currentColor" opacity="0.2"/>
                        <path d="M18 16v4m-2-2h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Inbox Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Receive mentions. Anyone can write if they tag your pubkey. Open read access.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-amber-500/10 text-amber-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Open Read</span>
                    <span class="bg-amber-500/10 text-amber-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Tagged Write</span>
                </div>
            </button>

            <!-- DM Relay -->
            <button @click="selectPreset('dm')" class="preset-card bg-gray-900 border border-gray-800 hover:border-rose-500/50 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-rose-500/10 flex items-center justify-center mb-4 group-hover:bg-rose-500/20 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-rose-400">
                        <path d="M21 12c0 4.418-4.03 8-9 8a9.86 9.86 0 0 1-4.255-.964L3 20l1.338-3.123C3.49 15.509 3 13.812 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M9 12h.01M12 12h.01M15 12h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="18" cy="5" r="3" fill="currentColor" opacity="0.3"/>
                        <path d="M17 5h2M18 4v2" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">DM Relay</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Private messages. Anyone can write if tagging you. Only approved keys can read with AUTH.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-rose-500/10 text-rose-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Auth Read</span>
                    <span class="bg-rose-500/10 text-rose-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Tagged Write</span>
                </div>
            </button>

            <!-- Advanced / Custom -->
            <button @click="showCreateForm()" class="preset-card bg-gray-900 border border-gray-800 border-dashed hover:border-gray-600 rounded-xl p-6 text-left group">
                <div class="w-12 h-12 rounded-xl bg-gray-800 flex items-center justify-center mb-4 group-hover:bg-gray-700 transition">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="text-gray-400">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h3 class="font-semibold text-white mb-1">Advanced Setup</h3>
                <p class="text-xs text-gray-400 leading-relaxed">Full control. Configure every policy option manually from scratch.</p>
                <div class="flex gap-1.5 mt-3">
                    <span class="bg-gray-800 text-gray-400 rounded-full px-2 py-0.5 text-[10px] font-medium">Custom</span>
                </div>
            </button>
        </div>
    </main>

    <!-- ==================== SIMPLE PRESET FORM VIEW ==================== -->
    <main x-show="currentView === 'simpleForm'" class="max-w-2xl mx-auto px-6 py-8">
        <button @click="currentView = 'presets'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to presets
        </button>

        <div class="mb-6">
            <h2 class="text-lg font-semibold" x-text="'Create ' + presetLabel(selectedPreset) + ' Relay'"></h2>
            <p class="text-sm text-gray-400 mt-1" x-text="presetDescription(selectedPreset)"></p>
        </div>

        <!-- Basic fields -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Relay ID</label>
                <input type="text" x-model="form.id" placeholder="e.g. public, my-outbox"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1">Alphanumeric, hyphens, underscores. Used in the config file.</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" x-model="form.name"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Description</label>
                <textarea x-model="form.description" rows="2"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600"></textarea>
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-1">Subdomain</label>
                <input type="text" x-model="form.subdomain" placeholder="e.g. outbox"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1" x-show="form.subdomain" x-text="'wss://' + form.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></p>
            </div>
        </div>

        <!-- Auto-fill db_path from subdomain -->
        <template x-effect="if (!editingRelay && form.subdomain && !form.db_path_manual) form.db_path = 'data/' + form.subdomain + '.mdb'"></template>

        <!-- Pubkeys section (shown for presets that need them) -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4" x-show="presetNeedsPubkeys(selectedPreset)">
            <h3 class="text-sm font-medium text-gray-400 mb-1" x-text="presetPubkeyLabel(selectedPreset)"></h3>
            <p class="text-xs text-gray-500 mb-3" x-text="presetPubkeyHint(selectedPreset)"></p>
            <div class="flex flex-wrap gap-1.5 mb-2">
                <template x-for="(item, index) in simpleFormPubkeys" :key="index">
                    <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                        <span x-text="item.length > 20 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                        <button @click="simpleFormPubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                    </span>
                </template>
            </div>
            <div class="flex gap-2">
                <input type="text" placeholder="Enter npub or hex pubkey"
                    @keydown.enter.prevent="addSimplePubkey($event)"
                    class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <button type="button" @click="addSimplePubkey({ target: $el.previousElementSibling })" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
            </div>
        </div>

        <!-- Error -->
        <div x-show="formError" class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4 text-sm" x-text="formError"></div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button @click="savePresetRelay()" class="bg-white text-gray-900 px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">Create Relay</button>
            <button @click="currentView = 'presets'" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
            <button @click="convertToAdvanced()" class="ml-auto text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Advanced Setup â†’</button>
        </div>
    </main>

    <!-- ==================== ADVANCED FORM VIEW ==================== -->
    <main x-show="currentView === 'form'" class="max-w-2xl mx-auto px-6 py-8">
        <button @click="editingRelay ? (currentView = 'list') : (currentView = 'presets')" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back
        </button>

        <h2 class="text-lg font-semibold mb-6" x-text="editingRelay ? 'Edit Relay' : 'Advanced Setup'"></h2>

        <!-- Basic Info -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Basic Info</h3>

            <template x-if="!editingRelay">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">ID</label>
                    <input type="text" x-model="form.id" placeholder="e.g. public, outbox, dms"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <p class="text-xs text-gray-500 mt-1">Alphanumeric, hyphens, underscores only. Cannot be changed later.</p>
                </div>
            </template>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" x-model="form.name" placeholder="My Relay"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Description</label>
                <textarea x-model="form.description" rows="2" placeholder="Optional description"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Subdomain</label>
                <input type="text" x-model="form.subdomain" placeholder="e.g. outbox"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1" x-show="form.subdomain" x-text="'wss://' + form.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></p>
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-1">DB Path</label>
                <input type="text" x-model="form.db_path" placeholder="data/relay.mdb"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>
        </div>

        <!-- Auto-fill db_path from subdomain -->
        <template x-effect="if (!editingRelay && form.subdomain && !form.db_path_manual) form.db_path = 'data/' + form.subdomain + '.mdb'"></template>

        <!-- Write Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Write Policy</h3>

            <div class="flex items-center justify-between mb-4">
                <span class="text-sm">Require Auth</span>
                <button @click="form.write_require_auth = !form.write_require_auth" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="form.write_require_auth ? 'bg-white' : 'bg-gray-700'">
                    <span class="inline-block h-4 w-4 rounded-full transition-transform" :class="form.write_require_auth ? 'translate-x-6 bg-gray-900' : 'translate-x-1 bg-gray-400'"></span>
                </button>
            </div>

            <div class="mb-4" x-data="tagInput()" x-init="items = form.write_allowed_pubkeys">
                <label class="block text-sm text-gray-400 mb-1">Allowed Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.write_allowed_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.write_allowed_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Enter pubkey" @keydown.enter.prevent="addTag($event, form.write_allowed_pubkeys)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addTag({ target: $el.previousElementSibling }, form.write_allowed_pubkeys)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>

            <div class="mb-4" x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Blocked Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.write_blocked_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.write_blocked_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Enter pubkey" @keydown.enter.prevent="addTag($event, form.write_blocked_pubkeys)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addTag({ target: $el.previousElementSibling }, form.write_blocked_pubkeys)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>

            <div x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Tagged Pubkeys</label>
                <p class="text-xs text-gray-500 mb-2">If set, events must contain a <code class="bg-gray-800 px-1 rounded">p</code> tag referencing one of these pubkeys to be accepted.</p>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.write_tagged_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.write_tagged_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Enter pubkey" @keydown.enter.prevent="addTag($event, form.write_tagged_pubkeys)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addTag({ target: $el.previousElementSibling }, form.write_tagged_pubkeys)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>

            <div class="mt-4" x-show="wots.length > 0">
                <label class="block text-sm text-gray-400 mb-1">Web of Trust</label>
                <p class="text-xs text-gray-500 mb-2">If set, only pubkeys in this WoT can write.</p>
                <select x-model="form.write_wot" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-gray-600">
                    <option value="">None</option>
                    <template x-for="wot in wots" :key="wot.id">
                        <option :value="wot.id" x-text="wot.id + ' (' + wot.pubkey_count + ' keys, ' + wot.status.state + ')'"></option>
                    </template>
                </select>
            </div>
        </div>

        <!-- Read Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Read Policy</h3>

            <div class="flex items-center justify-between mb-4">
                <span class="text-sm">Require Auth</span>
                <button @click="form.read_require_auth = !form.read_require_auth" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="form.read_require_auth ? 'bg-white' : 'bg-gray-700'">
                    <span class="inline-block h-4 w-4 rounded-full transition-transform" :class="form.read_require_auth ? 'translate-x-6 bg-gray-900' : 'translate-x-1 bg-gray-400'"></span>
                </button>
            </div>

            <div x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Allowed Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.read_allowed_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="form.read_allowed_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Enter pubkey" @keydown.enter.prevent="addTag($event, form.read_allowed_pubkeys)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addTag({ target: $el.previousElementSibling }, form.read_allowed_pubkeys)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>

            <div class="mt-4" x-show="wots.length > 0">
                <label class="block text-sm text-gray-400 mb-1">Web of Trust</label>
                <p class="text-xs text-gray-500 mb-2">If set, only pubkeys in this WoT can read (requires AUTH).</p>
                <select x-model="form.read_wot" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-gray-600">
                    <option value="">None</option>
                    <template x-for="wot in wots" :key="wot.id">
                        <option :value="wot.id" x-text="wot.id + ' (' + wot.pubkey_count + ' keys, ' + wot.status.state + ')'"></option>
                    </template>
                </select>
            </div>
        </div>

        <!-- Event Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Event Policy</h3>

            <div class="mb-4" x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Allowed Kinds</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.allowed_kinds" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item"></span>
                            <button @click="form.allowed_kinds.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="number" placeholder="Enter kind number" @keydown.enter.prevent="addNumTag($event, form.allowed_kinds)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addNumTag({ target: $el.previousElementSibling }, form.allowed_kinds)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>

            <div class="mb-4" x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Blocked Kinds</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in form.blocked_kinds" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item"></span>
                            <button @click="form.blocked_kinds.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="number" placeholder="Enter kind number" @keydown.enter.prevent="addNumTag($event, form.blocked_kinds)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addNumTag({ target: $el.previousElementSibling }, form.blocked_kinds)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Min PoW</label>
                    <input type="number" x-model.number="form.min_pow" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Max Content Length</label>
                    <input type="number" x-model.number="form.max_content_length" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Custom Home Page -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4" x-show="editingRelay">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-medium text-gray-400">Custom Home Page</h3>
                <div class="flex items-center gap-2">
                    <button @click="previewPage()" x-show="form.page_html" class="text-xs text-gray-400 hover:text-white border border-gray-700 rounded px-2 py-1 transition">Preview</button>
                    <button @click="form.page_html ? deletePage() : null" x-show="form.page_html" class="text-xs text-red-400 hover:text-red-300 px-2 py-1 transition">Remove</button>
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-3">Custom HTML served when someone visits this relay's URL in a browser. Leave empty for the default page. You can also place a file at <code class="bg-gray-800 px-1 rounded">pages/<span x-text="form.id"></span>.html</code>.</p>
            <textarea x-model="form.page_html" rows="12" placeholder="<!DOCTYPE html>&#10;<html>&#10;  <head><title>My Relay</title></head>&#10;  <body>...</body>&#10;</html>"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600 font-mono" spellcheck="false"></textarea>
        </div>

        <!-- Rate Limits -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-6">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Rate Limits</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Writes/min</label>
                    <input type="number" x-model.number="form.writes_per_minute" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Reads/min</label>
                    <input type="number" x-model.number="form.reads_per_minute" placeholder="None"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Error message -->
        <div x-show="formError" class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4 text-sm" x-text="formError"></div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button @click="saveRelay()" class="bg-white text-gray-900 px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">Save</button>
            <button @click="editingRelay ? (currentView = 'list') : (currentView = 'presets')" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
            <template x-if="editingRelay">
                <button @click="confirmDelete(editingRelay)" class="ml-auto text-sm text-red-400 hover:text-red-300 px-4 py-2 transition">Delete</button>
            </template>
        </div>
    </main>

    <!-- ==================== WOT LIST VIEW ==================== -->
    <main x-show="currentView === 'wotList'" class="max-w-4xl mx-auto px-6 py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Web of Trust</h2>
            <button @click="showWotCreateForm()" class="bg-white text-gray-900 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">
                Create WoT
            </button>
        </div>

        <!-- Discovery Relays -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-6" x-data="tagInput()">
            <h3 class="text-sm font-medium text-gray-400 mb-1">Discovery Relays</h3>
            <p class="text-xs text-gray-500 mb-3">Relays used to crawl follow lists when building WoTs.</p>
            <div class="flex flex-wrap gap-1.5 mb-2">
                <template x-for="(item, index) in discoveryRelays" :key="index">
                    <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                        <span x-text="item"></span>
                        <button @click="discoveryRelays.splice(index, 1); saveDiscoveryRelays()" class="text-gray-400 hover:text-white">&times;</button>
                    </span>
                </template>
            </div>
            <div class="flex gap-2">
                <input type="text" placeholder="wss://relay.example.com" @keydown.enter.prevent="addDiscoveryRelay($event)"
                    class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <button type="button" @click="addDiscoveryRelay({ target: $el.previousElementSibling })" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
            </div>
        </div>

        <!-- WoT Cards -->
        <div class="grid gap-4">
            <template x-for="wot in wots" :key="wot.id">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-5">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-semibold text-white" x-text="wot.id"></h3>
                            <p class="text-sm text-gray-400 mt-1 font-mono" x-text="wot.config.seed.length > 20 ? wot.config.seed.slice(0, 12) + '...' + wot.config.seed.slice(-4) : wot.config.seed"></p>
                        </div>
                        <span class="text-xs rounded-full px-2.5 py-1 font-medium"
                            :class="{
                                'bg-gray-800 text-gray-400': wot.status.state === 'Pending',
                                'bg-amber-500/10 text-amber-400': wot.status.state === 'Building',
                                'bg-emerald-500/10 text-emerald-400': wot.status.state === 'Ready',
                                'bg-red-500/10 text-red-400': wot.status.state === 'Error',
                            }"
                            x-text="wot.status.state === 'Building' ? 'Building ' + (wot.status.depth_progress || 0) + '/' + (wot.status.total_depth || '?') : wot.status.state"></span>
                    </div>
                    <div class="flex flex-wrap gap-3 text-xs text-gray-400 mt-3 mb-4">
                        <span x-text="'Depth: ' + wot.config.depth"></span>
                        <span x-text="wot.pubkey_count.toLocaleString() + ' pubkeys'"></span>
                        <span x-text="'Refresh: ' + wot.config.update_interval_hours + 'h'"></span>
                        <span x-show="wot.last_updated" x-text="'Updated: ' + new Date(wot.last_updated * 1000).toLocaleString()"></span>
                    </div>
                    <template x-if="wot.status.state === 'Error'">
                        <p class="text-xs text-red-400 mb-3" x-text="wot.status.message"></p>
                    </template>
                    <div class="flex gap-3">
                        <button @click="showWotEditForm(wot)" class="text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Edit</button>
                        <button @click="confirmDeleteWot(wot)" class="text-sm text-red-400 hover:text-red-300 px-3 py-1.5 transition">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="wots.length === 0" class="text-center text-gray-500 py-12">
            No Web of Trust configurations. Create one to get started.
        </div>
    </main>

    <!-- ==================== WOT FORM VIEW ==================== -->
    <main x-show="currentView === 'wotForm'" class="max-w-2xl mx-auto px-6 py-8">
        <button @click="currentView = 'wotList'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to Web of Trust
        </button>

        <h2 class="text-lg font-semibold mb-6" x-text="editingWot ? 'Edit WoT' : 'Create WoT'"></h2>

        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <template x-if="!editingWot">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">ID</label>
                    <input type="text" x-model="wotForm.id" placeholder="e.g. my-follows"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <p class="text-xs text-gray-500 mt-1">Alphanumeric, hyphens, underscores. Referenced in relay policies.</p>
                </div>
            </template>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Seed Pubkey</label>
                <input type="text" x-model="wotForm.seed" placeholder="npub1... or hex"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1">The starting pubkey whose follow list is crawled.</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Depth</label>
                    <input type="number" x-model.number="wotForm.depth" min="1" max="4"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <p class="text-xs text-gray-500 mt-1">1-4. Depth 2 yields ~50k pubkeys.</p>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Update Interval (hours)</label>
                    <input type="number" x-model.number="wotForm.update_interval_hours" min="1"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                </div>
            </div>
        </div>

        <!-- Error message -->
        <div x-show="wotFormError" class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4 text-sm" x-text="wotFormError"></div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button @click="saveWot()" class="bg-white text-gray-900 px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">Save</button>
            <button @click="currentView = 'wotList'" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
        </div>
    </main>

    <!-- ==================== BLOSSOM LIST VIEW ==================== -->
    <main x-show="currentView === 'blossomList'" class="max-w-4xl mx-auto px-6 py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Blossom Media Servers</h2>
            <button @click="showBlossomCreateForm()" class="bg-white text-gray-900 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">
                Create Server
            </button>
        </div>

        <div class="grid gap-4">
            <template x-for="blossom in blossoms" :key="blossom.id">
                <div class="bg-gray-900 border border-gray-800 rounded-lg p-5">
                    <div class="flex items-start justify-between mb-2">
                        <div>
                            <h3 class="font-semibold text-white" x-text="blossom.name"></h3>
                            <p class="text-sm text-gray-400 mt-1" x-text="blossom.description || 'No description'"></p>
                        </div>
                    </div>
                    <div class="mt-3 mb-3">
                        <span class="inline-block bg-gray-800 text-gray-300 text-xs font-mono rounded-full px-3 py-1" x-text="'https://' + blossom.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></span>
                    </div>
                    <div class="flex flex-wrap gap-1.5 mb-4">
                        <template x-if="blossom.policy?.upload?.allowed_pubkeys?.length">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="blossom.policy.upload.allowed_pubkeys.length + ' upload keys'"></span>
                        </template>
                        <template x-if="!blossom.policy?.upload?.allowed_pubkeys">
                            <span class="bg-emerald-500/10 text-emerald-400 rounded-full px-2 py-1 text-xs">Open Upload</span>
                        </template>
                        <template x-if="blossom.policy?.list?.require_auth">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs">List Auth</span>
                        </template>
                        <template x-if="blossom.policy?.max_file_size">
                            <span class="bg-gray-800 text-gray-300 rounded-full px-2 py-1 text-xs" x-text="Math.round(blossom.policy.max_file_size / 1048576) + ' MB max'"></span>
                        </template>
                    </div>
                    <div class="flex gap-3">
                        <button @click="showBlossomMedia(blossom)" class="text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Media</button>
                        <button @click="showBlossomEditForm(blossom)" class="text-sm text-gray-400 hover:text-white border border-gray-700 rounded px-3 py-1.5 transition">Edit</button>
                        <button @click="confirmDeleteBlossom(blossom)" class="text-sm text-red-400 hover:text-red-300 px-3 py-1.5 transition">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="blossoms.length === 0" class="text-center text-gray-500 py-12">
            No Blossom servers configured. Create one to get started.
        </div>
    </main>

    <!-- ==================== BLOSSOM FORM VIEW ==================== -->
    <main x-show="currentView === 'blossomForm'" class="max-w-2xl mx-auto px-6 py-8">
        <button @click="currentView = 'blossomList'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to Blossom
        </button>

        <h2 class="text-lg font-semibold mb-6" x-text="editingBlossom ? 'Edit Blossom Server' : 'Create Blossom Server'"></h2>

        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Basic Info</h3>

            <template x-if="!editingBlossom">
                <div class="mb-4">
                    <label class="block text-sm text-gray-400 mb-1">ID</label>
                    <input type="text" x-model="blossomForm.id" placeholder="e.g. media, cdn"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <p class="text-xs text-gray-500 mt-1">Alphanumeric, hyphens, underscores only.</p>
                </div>
            </template>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Name</label>
                <input type="text" x-model="blossomForm.name" placeholder="Media Server"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Description</label>
                <textarea x-model="blossomForm.description" rows="2" placeholder="Optional description"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-sm text-gray-400 mb-1">Subdomain</label>
                <input type="text" x-model="blossomForm.subdomain" placeholder="e.g. media"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                <p class="text-xs text-gray-500 mt-1" x-show="blossomForm.subdomain" x-text="'https://' + blossomForm.subdomain + '.' + statusInfo.domain + ':' + statusInfo.port"></p>
            </div>

            <div>
                <label class="block text-sm text-gray-400 mb-1">Storage Path</label>
                <input type="text" x-model="blossomForm.storage_path" placeholder="data/blossom/media"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>
        </div>

        <!-- Auto-fill storage_path from subdomain -->
        <template x-effect="if (!editingBlossom && blossomForm.subdomain && !blossomForm.storage_path_manual) blossomForm.storage_path = 'data/blossom/' + blossomForm.subdomain"></template>

        <!-- Upload Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Upload Policy</h3>

            <div x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Allowed Pubkeys</label>
                <p class="text-xs text-gray-500 mb-2">If set, only these pubkeys can upload. Leave empty for open uploads.</p>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in blossomForm.upload_allowed_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="blossomForm.upload_allowed_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Enter pubkey" @keydown.enter.prevent="addTag($event, blossomForm.upload_allowed_pubkeys)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addTag({ target: $el.previousElementSibling }, blossomForm.upload_allowed_pubkeys)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>
        </div>

        <!-- List Policy -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-4">List Policy</h3>

            <div class="flex items-center justify-between mb-4">
                <span class="text-sm">Require Auth</span>
                <button @click="blossomForm.list_require_auth = !blossomForm.list_require_auth" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors" :class="blossomForm.list_require_auth ? 'bg-white' : 'bg-gray-700'">
                    <span class="inline-block h-4 w-4 rounded-full transition-transform" :class="blossomForm.list_require_auth ? 'translate-x-6 bg-gray-900' : 'translate-x-1 bg-gray-400'"></span>
                </button>
            </div>

            <div x-data="tagInput()">
                <label class="block text-sm text-gray-400 mb-1">Allowed Pubkeys</label>
                <div class="flex flex-wrap gap-1.5 mb-2">
                    <template x-for="(item, index) in blossomForm.list_allowed_pubkeys" :key="index">
                        <span class="bg-gray-700 text-gray-200 rounded px-2 py-1 text-xs inline-flex items-center gap-1">
                            <span x-text="item.length > 16 ? item.slice(0, 12) + '...' + item.slice(-4) : item"></span>
                            <button @click="blossomForm.list_allowed_pubkeys.splice(index, 1)" class="text-gray-400 hover:text-white">&times;</button>
                        </span>
                    </template>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Enter pubkey" @keydown.enter.prevent="addTag($event, blossomForm.list_allowed_pubkeys)"
                        class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
                    <button type="button" @click="addTag({ target: $el.previousElementSibling }, blossomForm.list_allowed_pubkeys)" class="bg-gray-800 border border-gray-700 hover:border-gray-500 text-gray-300 hover:text-white rounded-lg px-3 py-2 text-sm transition">Add</button>
                </div>
            </div>
        </div>

        <!-- Max File Size -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-6">
            <h3 class="text-sm font-medium text-gray-400 mb-4">Limits</h3>
            <div>
                <label class="block text-sm text-gray-400 mb-1">Max File Size (MB)</label>
                <input type="number" x-model.number="blossomForm.max_file_size_mb" placeholder="100"
                    class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-gray-600">
            </div>
        </div>

        <!-- Error message -->
        <div x-show="blossomFormError" class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded-lg mb-4 text-sm" x-text="blossomFormError"></div>

        <!-- Actions -->
        <div class="flex items-center gap-3">
            <button @click="saveBlossom()" class="bg-white text-gray-900 px-5 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition">Save</button>
            <button @click="currentView = 'blossomList'" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
            <template x-if="editingBlossom">
                <button @click="confirmDeleteBlossom(editingBlossom)" class="ml-auto text-sm text-red-400 hover:text-red-300 px-4 py-2 transition">Delete</button>
            </template>
        </div>
    </main>

    <!-- ==================== BLOSSOM MEDIA VIEW ==================== -->
    <main x-show="currentView === 'blossomMedia'" class="max-w-4xl mx-auto px-6 py-8">
        <button @click="currentView = 'blossomList'" class="text-sm text-gray-400 hover:text-white mb-6 inline-flex items-center gap-1 transition">
            &larr; Back to Blossom
        </button>

        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold" x-text="blossomMediaServer?.name + ' â€” Media'"></h2>
        </div>

        <!-- Upload Area -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 mb-6">
            <h3 class="text-sm font-medium text-gray-400 mb-3">Upload</h3>
            <div class="flex gap-3 items-center">
                <input type="file" x-ref="blossomFileInput" class="text-sm text-gray-400 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-gray-800 file:text-gray-300 hover:file:bg-gray-700 file:transition file:cursor-pointer" multiple>
                <button @click="uploadMedia()" class="bg-white text-gray-900 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition whitespace-nowrap">Upload</button>
            </div>
            <div x-show="uploadProgress" class="mt-3 text-sm text-gray-400" x-text="uploadProgress"></div>
        </div>

        <!-- Media Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <template x-for="item in blossomMediaItems" :key="item.sha256">
                <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden group relative">
                    <!-- Preview -->
                    <div class="aspect-square bg-gray-800 flex items-center justify-center overflow-hidden">
                        <template x-if="item.type.startsWith('image/')">
                            <img :src="item.url" class="w-full h-full object-cover" loading="lazy">
                        </template>
                        <template x-if="item.type.startsWith('video/')">
                            <video :src="item.url" class="w-full h-full object-cover" muted></video>
                        </template>
                        <template x-if="!item.type.startsWith('image/') && !item.type.startsWith('video/')">
                            <div class="text-center p-3">
                                <svg class="w-8 h-8 text-gray-500 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                <p class="text-xs text-gray-500 truncate" x-text="item.type"></p>
                            </div>
                        </template>
                    </div>
                    <!-- Info -->
                    <div class="p-2">
                        <p class="text-xs text-gray-400 truncate font-mono" x-text="item.sha256.slice(0, 12) + '...'"></p>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-xs text-gray-500" x-text="formatSize(item.size)"></span>
                            <button @click="deleteMedia(item.sha256)" class="text-xs text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition">Delete</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <div x-show="blossomMediaItems.length === 0" class="text-center text-gray-500 py-12">
            No media uploaded yet.
        </div>
    </main>

    <!-- ==================== DELETE BLOSSOM MODAL ==================== -->
    <div x-show="deleteBlossomTarget" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
        <div class="absolute inset-0 bg-black/50" @click="deleteBlossomTarget = null"></div>
        <div class="relative bg-gray-900 border border-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-2">Delete Blossom Server</h3>
            <p class="text-sm text-gray-400 mb-6">Are you sure you want to delete <span class="text-white font-medium" x-text="deleteBlossomTarget?.name"></span>? This cannot be undone.</p>
            <div class="flex gap-3 justify-end">
                <button @click="deleteBlossomTarget = null" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
                <button @click="deleteBlossom()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- ==================== DELETE MODAL ==================== -->
    <div x-show="deleteTarget" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
        <div class="absolute inset-0 bg-black/50" @click="deleteTarget = null"></div>
        <div class="relative bg-gray-900 border border-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-2">Delete Relay</h3>
            <p class="text-sm text-gray-400 mb-6">Are you sure you want to delete <span class="text-white font-medium" x-text="deleteTarget?.name"></span>? This cannot be undone.</p>
            <div class="flex gap-3 justify-end">
                <button @click="deleteTarget = null" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
                <button @click="deleteRelay()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- ==================== DELETE WOT MODAL ==================== -->
    <div x-show="deleteWotTarget" class="fixed inset-0 z-50 flex items-center justify-center" x-cloak>
        <div class="absolute inset-0 bg-black/50" @click="deleteWotTarget = null"></div>
        <div class="relative bg-gray-900 border border-gray-800 rounded-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold mb-2">Delete WoT</h3>
            <p class="text-sm text-gray-400 mb-6">Are you sure you want to delete WoT <span class="text-white font-medium" x-text="deleteWotTarget?.id"></span>?</p>
            <div x-show="deleteWotError" class="bg-red-900/50 border border-red-700 text-red-200 px-3 py-2 rounded mb-4 text-sm" x-text="deleteWotError"></div>
            <div class="flex gap-3 justify-end">
                <button @click="deleteWotTarget = null; deleteWotError = ''" class="text-sm text-gray-400 hover:text-white px-4 py-2 transition">Cancel</button>
                <button @click="deleteWot()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <script>
        function tagInput() {
            return {
                addTag(event, arr) {
                    const val = event.target.value.trim();
                    if (val && !arr.includes(val)) {
                        arr.push(val);
                    }
                    event.target.value = '';
                },
                addNumTag(event, arr) {
                    const val = parseInt(event.target.value);
                    if (!isNaN(val) && !arr.includes(val)) {
                        arr.push(val);
                    }
                    event.target.value = '';
                }
            };
        }

        function adminApp() {
            return {
                relays: [],
                currentView: 'list',
                editingRelay: null,
                deleteTarget: null,
                pendingRestart: false,
                formError: '',
                selectedPreset: null,
                simpleFormPubkeys: [],
                statusInfo: { domain: 'localhost', port: 8080 },
                wots: [],
                discoveryRelays: [],
                editingWot: null,
                deleteWotTarget: null,
                deleteWotError: '',
                wotFormError: '',
                wotForm: { id: '', seed: '', depth: 1, update_interval_hours: 24 },
                blossoms: [],
                editingBlossom: null,
                deleteBlossomTarget: null,
                blossomFormError: '',
                blossomForm: {
                    id: '', name: '', description: '', subdomain: '', storage_path: '', storage_path_manual: false,
                    upload_allowed_pubkeys: [], list_require_auth: false, list_allowed_pubkeys: [], max_file_size_mb: '',
                },
                blossomMediaServer: null,
                blossomMediaId: '',
                blossomMediaItems: [],
                uploadProgress: '',
                form: {
                    id: '',
                    name: '',
                    description: '',
                    subdomain: '',
                    db_path: '',
                    db_path_manual: false,
                    write_require_auth: false,
                    write_allowed_pubkeys: [],
                    write_blocked_pubkeys: [],
                    write_tagged_pubkeys: [],
                    read_require_auth: false,
                    read_allowed_pubkeys: [],
                    allowed_kinds: [],
                    blocked_kinds: [],
                    min_pow: '',
                    max_content_length: '',
                    writes_per_minute: '',
                    reads_per_minute: '',
                    page_html: '',
                    write_wot: '',
                    read_wot: '',
                },

                emptyForm() {
                    return {
                        id: '',
                        name: '',
                        description: '',
                        subdomain: '',
                        db_path: '',
                        db_path_manual: false,
                        write_require_auth: false,
                        write_allowed_pubkeys: [],
                        write_blocked_pubkeys: [],
                        write_tagged_pubkeys: [],
                        read_require_auth: false,
                        read_allowed_pubkeys: [],
                        allowed_kinds: [],
                        blocked_kinds: [],
                        min_pow: '',
                        max_content_length: '',
                        writes_per_minute: '',
                        reads_per_minute: '',
                        page_html: '',
                        write_wot: '',
                        read_wot: '',
                    };
                },

                // ---- Preset helpers ----

                presetLabel(p) {
                    return { public: 'Public', private: 'Private', outbox: 'Outbox', inbox: 'Inbox', dm: 'DM' }[p] || '';
                },

                presetDescription(p) {
                    const descs = {
                        public: 'An open relay where anyone can read and write. No authentication required.',
                        private: 'A members-only relay. Add the pubkeys that should have access.',
                        outbox: 'Your personal broadcast. Only your pubkeys can write, but anyone can read.',
                        inbox: 'Receive mentions and replies. Anyone can write events that tag your pubkeys.',
                        dm: 'Private messaging. Anyone can send DMs tagging your pubkeys, but only approved keys can read.',
                    };
                    return descs[p] || '';
                },

                presetNeedsPubkeys(p) {
                    return ['private', 'outbox', 'inbox', 'dm'].includes(p);
                },

                presetPubkeyLabel(p) {
                    const labels = {
                        private: 'Approved Pubkeys',
                        outbox: 'Writer Pubkeys',
                        inbox: 'Your Pubkeys (to be tagged)',
                        dm: 'Your Pubkeys (to be tagged & read)',
                    };
                    return labels[p] || 'Pubkeys';
                },

                presetPubkeyHint(p) {
                    const hints = {
                        private: 'These pubkeys will be able to read and write to this relay.',
                        outbox: 'Only these pubkeys will be allowed to publish events.',
                        inbox: 'Events must tag one of these pubkeys to be accepted. Anyone can read.',
                        dm: 'Events must tag one of these pubkeys to be accepted. Only these pubkeys can read (with AUTH).',
                    };
                    return hints[p] || '';
                },

                selectPreset(preset) {
                    this.selectedPreset = preset;
                    this.simpleFormPubkeys = [];
                    this.formError = '';

                    const defaults = {
                        public:  { name: 'Public Relay', description: 'A fully open relay', subdomain: 'pub' },
                        private: { name: 'Private Relay', description: 'Members only', subdomain: 'private' },
                        outbox:  { name: 'My Outbox', description: 'Only I can post here', subdomain: 'outbox' },
                        inbox:   { name: 'Inbox', description: 'Receive mentions and replies', subdomain: 'inbox' },
                        dm:      { name: 'DM Relay', description: 'Private direct messages', subdomain: 'dm' },
                    };

                    const d = defaults[preset];
                    this.form = this.emptyForm();
                    this.form.id = preset;
                    this.form.name = d.name;
                    this.form.description = d.description;
                    this.form.subdomain = d.subdomain;
                    this.form.db_path = 'data/' + d.subdomain + '.mdb';

                    this.currentView = 'simpleForm';
                },

                addSimplePubkey(event) {
                    const val = event.target.value.trim();
                    if (val && !this.simpleFormPubkeys.includes(val)) {
                        this.simpleFormPubkeys.push(val);
                    }
                    event.target.value = '';
                },

                applyPresetPolicy() {
                    const keys = [...this.simpleFormPubkeys];
                    const p = this.selectedPreset;

                    if (p === 'public') {
                        // No restrictions
                    } else if (p === 'private') {
                        this.form.write_require_auth = true;
                        this.form.write_allowed_pubkeys = [...keys];
                        this.form.read_require_auth = true;
                        this.form.read_allowed_pubkeys = [...keys];
                    } else if (p === 'outbox') {
                        this.form.write_allowed_pubkeys = [...keys];
                    } else if (p === 'inbox') {
                        this.form.write_tagged_pubkeys = [...keys];
                    } else if (p === 'dm') {
                        this.form.write_tagged_pubkeys = [...keys];
                        this.form.read_require_auth = true;
                        this.form.read_allowed_pubkeys = [...keys];
                        this.form.allowed_kinds = [4, 1059, 5];
                    }
                },

                async savePresetRelay() {
                    this.formError = '';
                    if (this.presetNeedsPubkeys(this.selectedPreset) && this.simpleFormPubkeys.length === 0) {
                        this.formError = 'Add at least one pubkey.';
                        return;
                    }
                    this.applyPresetPolicy();
                    await this.saveRelay();
                },

                convertToAdvanced() {
                    this.applyPresetPolicy();
                    this.editingRelay = null;
                    this.currentView = 'form';
                },

                // ---- Core CRUD ----

                async init() {
                    await this.fetchStatus();
                    await this.fetchRelays();
                    await this.fetchWots();
                    await this.fetchBlossoms();
                    await this.fetchDiscoveryRelays();
                },

                async fetchStatus() {
                    try {
                        const res = await fetch('/api/status');
                        if (res.ok) {
                            const data = await res.json();
                            this.pendingRestart = data.pending_restart;
                            this.statusInfo = { domain: data.domain, port: data.port };
                        }
                    } catch (e) { console.error('Failed to fetch status', e); }
                },

                async fetchRelays() {
                    try {
                        const res = await fetch('/api/relays');
                        if (res.ok) {
                            this.relays = await res.json();
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        }
                    } catch (e) { console.error('Failed to fetch relays', e); }
                },

                showCreateForm() {
                    this.editingRelay = null;
                    this.form = this.emptyForm();
                    this.formError = '';
                    this.currentView = 'form';
                },

                async showEditForm(relay) {
                    this.editingRelay = relay;
                    this.formError = '';
                    await this.fetchWots();
                    const p = relay.policy || {};
                    const w = p.write || {};
                    const r = p.read || {};
                    const e = p.events || {};
                    const rl = p.rate_limit || {};
                    this.form = {
                        id: relay.id,
                        name: relay.name,
                        description: relay.description || '',
                        subdomain: relay.subdomain,
                        db_path: relay.db_path,
                        db_path_manual: true,
                        write_require_auth: w.require_auth || false,
                        write_allowed_pubkeys: [...(w.allowed_pubkeys || [])],
                        write_blocked_pubkeys: [...(w.blocked_pubkeys || [])],
                        write_tagged_pubkeys: [...(w.tagged_pubkeys || [])],
                        read_require_auth: r.require_auth || false,
                        read_allowed_pubkeys: [...(r.allowed_pubkeys || [])],
                        allowed_kinds: [...(e.allowed_kinds || [])],
                        blocked_kinds: [...(e.blocked_kinds || [])],
                        min_pow: e.min_pow ?? '',
                        max_content_length: e.max_content_length ?? '',
                        writes_per_minute: rl.writes_per_minute ?? '',
                        reads_per_minute: rl.reads_per_minute ?? '',
                        page_html: '',
                        write_wot: w.wot || '',
                        read_wot: r.wot || '',
                    };
                    try {
                        const res = await fetch(`/api/relays/${relay.id}/page`);
                        if (res.ok) {
                            const data = await res.json();
                            this.form.page_html = data.html || '';
                        }
                    } catch (e) { console.error('Failed to fetch page', e); }
                    this.currentView = 'form';
                },

                collectFormData() {
                    const data = {
                        name: this.form.name,
                        description: this.form.description || null,
                        subdomain: this.form.subdomain,
                        db_path: this.form.db_path,
                        policy: {
                            write: {
                                require_auth: this.form.write_require_auth,
                                allowed_pubkeys: this.form.write_allowed_pubkeys.length ? this.form.write_allowed_pubkeys : null,
                                blocked_pubkeys: this.form.write_blocked_pubkeys.length ? this.form.write_blocked_pubkeys : null,
                                tagged_pubkeys: this.form.write_tagged_pubkeys.length ? this.form.write_tagged_pubkeys : null,
                                wot: this.form.write_wot || null,
                            },
                            read: {
                                require_auth: this.form.read_require_auth,
                                allowed_pubkeys: this.form.read_allowed_pubkeys.length ? this.form.read_allowed_pubkeys : null,
                                wot: this.form.read_wot || null,
                            },
                            events: {
                                allowed_kinds: this.form.allowed_kinds.length ? this.form.allowed_kinds : null,
                                blocked_kinds: this.form.blocked_kinds.length ? this.form.blocked_kinds : null,
                                min_pow: this.form.min_pow !== '' ? Number(this.form.min_pow) : null,
                                max_content_length: this.form.max_content_length !== '' ? Number(this.form.max_content_length) : null,
                            },
                            rate_limit: (this.form.writes_per_minute !== '' || this.form.reads_per_minute !== '') ? {
                                writes_per_minute: this.form.writes_per_minute !== '' ? Number(this.form.writes_per_minute) : null,
                                reads_per_minute: this.form.reads_per_minute !== '' ? Number(this.form.reads_per_minute) : null,
                            } : null,
                        }
                    };
                    if (!this.editingRelay) {
                        data.id = this.form.id;
                    }
                    return data;
                },

                async saveRelay() {
                    this.formError = '';
                    const data = this.collectFormData();

                    try {
                        let res;
                        if (this.editingRelay) {
                            res = await fetch(`/api/relays/${this.editingRelay.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });
                        } else {
                            res = await fetch('/api/relays', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });
                        }

                        if (res.ok) {
                            const relayId = this.editingRelay ? this.editingRelay.id : this.form.id;
                            if (this.form.page_html) {
                                await fetch(`/api/relays/${relayId}/page`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ html: this.form.page_html }),
                                });
                            } else if (this.editingRelay) {
                                await fetch(`/api/relays/${relayId}/page`, { method: 'DELETE' });
                            }
                            await this.fetchRelays();
                            await this.fetchStatus();
                            this.currentView = 'list';
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            this.formError = await res.text();
                        }
                    } catch (e) {
                        this.formError = 'Network error: ' + e.message;
                    }
                },

                confirmDelete(relay) {
                    this.deleteTarget = relay;
                },

                async deleteRelay() {
                    if (!this.deleteTarget) return;
                    try {
                        const res = await fetch(`/api/relays/${this.deleteTarget.id}`, { method: 'DELETE' });
                        if (res.ok || res.status === 204) {
                            this.deleteTarget = null;
                            await this.fetchRelays();
                            await this.fetchStatus();
                            if (this.currentView === 'form') {
                                this.currentView = 'list';
                            }
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            alert('Delete failed: ' + await res.text());
                        }
                    } catch (e) {
                        alert('Network error: ' + e.message);
                    }
                },

                previewPage() {
                    const win = window.open('', '_blank');
                    win.document.write(this.form.page_html);
                    win.document.close();
                },

                async deletePage() {
                    if (!this.editingRelay) return;
                    await fetch(`/api/relays/${this.editingRelay.id}/page`, { method: 'DELETE' });
                    this.form.page_html = '';
                },

                // ---- WoT CRUD ----

                async fetchWots() {
                    try {
                        const res = await fetch('/api/wots');
                        if (res.ok) {
                            this.wots = await res.json();
                        }
                    } catch (e) { console.error('Failed to fetch WoTs', e); }
                },

                async fetchDiscoveryRelays() {
                    try {
                        const res = await fetch('/api/discovery-relays');
                        if (res.ok) {
                            this.discoveryRelays = await res.json();
                        }
                    } catch (e) { console.error('Failed to fetch discovery relays', e); }
                },

                addDiscoveryRelay(event) {
                    const val = event.target.value.trim();
                    if (val && !this.discoveryRelays.includes(val)) {
                        this.discoveryRelays.push(val);
                        this.saveDiscoveryRelays();
                    }
                    event.target.value = '';
                },

                async saveDiscoveryRelays() {
                    try {
                        await fetch('/api/discovery-relays', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ relays: this.discoveryRelays }),
                        });
                    } catch (e) { console.error('Failed to save discovery relays', e); }
                },

                showWotCreateForm() {
                    this.editingWot = null;
                    this.wotForm = { id: '', seed: '', depth: 1, update_interval_hours: 24 };
                    this.wotFormError = '';
                    this.currentView = 'wotForm';
                },

                showWotEditForm(wot) {
                    this.editingWot = wot;
                    this.wotForm = {
                        id: wot.id,
                        seed: wot.config.seed,
                        depth: wot.config.depth,
                        update_interval_hours: wot.config.update_interval_hours,
                    };
                    this.wotFormError = '';
                    this.currentView = 'wotForm';
                },

                async saveWot() {
                    this.wotFormError = '';
                    try {
                        let res;
                        if (this.editingWot) {
                            res = await fetch(`/api/wots/${this.editingWot.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    seed: this.wotForm.seed,
                                    depth: this.wotForm.depth,
                                    update_interval_hours: this.wotForm.update_interval_hours,
                                }),
                            });
                        } else {
                            res = await fetch('/api/wots', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.wotForm),
                            });
                        }
                        if (res.ok || res.status === 201) {
                            await this.fetchWots();
                            await this.fetchStatus();
                            this.currentView = 'wotList';
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            this.wotFormError = await res.text();
                        }
                    } catch (e) {
                        this.wotFormError = 'Network error: ' + e.message;
                    }
                },

                confirmDeleteWot(wot) {
                    this.deleteWotTarget = wot;
                    this.deleteWotError = '';
                },

                async deleteWot() {
                    if (!this.deleteWotTarget) return;
                    try {
                        const res = await fetch(`/api/wots/${this.deleteWotTarget.id}`, { method: 'DELETE' });
                        if (res.ok || res.status === 204) {
                            this.deleteWotTarget = null;
                            this.deleteWotError = '';
                            await this.fetchWots();
                            await this.fetchStatus();
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            this.deleteWotError = await res.text();
                        }
                    } catch (e) {
                        this.deleteWotError = 'Network error: ' + e.message;
                    }
                },

                // ---- Blossom CRUD ----

                async fetchBlossoms() {
                    try {
                        const res = await fetch('/api/blossoms');
                        if (res.ok) {
                            this.blossoms = await res.json();
                        }
                    } catch (e) { console.error('Failed to fetch blossoms', e); }
                },

                emptyBlossomForm() {
                    return {
                        id: '', name: '', description: '', subdomain: '', storage_path: '', storage_path_manual: false,
                        upload_allowed_pubkeys: [], list_require_auth: false, list_allowed_pubkeys: [], max_file_size_mb: '',
                    };
                },

                showBlossomCreateForm() {
                    this.editingBlossom = null;
                    this.blossomForm = this.emptyBlossomForm();
                    this.blossomFormError = '';
                    this.currentView = 'blossomForm';
                },

                showBlossomEditForm(blossom) {
                    this.editingBlossom = blossom;
                    this.blossomFormError = '';
                    const p = blossom.policy || {};
                    const u = p.upload || {};
                    const l = p.list || {};
                    this.blossomForm = {
                        id: blossom.id,
                        name: blossom.name,
                        description: blossom.description || '',
                        subdomain: blossom.subdomain,
                        storage_path: blossom.storage_path,
                        storage_path_manual: true,
                        upload_allowed_pubkeys: [...(u.allowed_pubkeys || [])],
                        list_require_auth: l.require_auth || false,
                        list_allowed_pubkeys: [...(l.allowed_pubkeys || [])],
                        max_file_size_mb: p.max_file_size ? Math.round(p.max_file_size / 1048576) : '',
                    };
                    this.currentView = 'blossomForm';
                },

                collectBlossomFormData() {
                    const data = {
                        name: this.blossomForm.name,
                        description: this.blossomForm.description || null,
                        subdomain: this.blossomForm.subdomain,
                        storage_path: this.blossomForm.storage_path,
                        policy: {
                            upload: {
                                allowed_pubkeys: this.blossomForm.upload_allowed_pubkeys.length ? this.blossomForm.upload_allowed_pubkeys : null,
                            },
                            list: {
                                require_auth: this.blossomForm.list_require_auth,
                                allowed_pubkeys: this.blossomForm.list_allowed_pubkeys.length ? this.blossomForm.list_allowed_pubkeys : null,
                            },
                            max_file_size: this.blossomForm.max_file_size_mb !== '' ? Number(this.blossomForm.max_file_size_mb) * 1048576 : null,
                        }
                    };
                    if (!this.editingBlossom) {
                        data.id = this.blossomForm.id;
                    }
                    return data;
                },

                async saveBlossom() {
                    this.blossomFormError = '';
                    const data = this.collectBlossomFormData();
                    try {
                        let res;
                        if (this.editingBlossom) {
                            res = await fetch(`/api/blossoms/${this.editingBlossom.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });
                        } else {
                            res = await fetch('/api/blossoms', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data),
                            });
                        }
                        if (res.ok || res.status === 201) {
                            await this.fetchBlossoms();
                            await this.fetchStatus();
                            this.currentView = 'blossomList';
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            this.blossomFormError = await res.text();
                        }
                    } catch (e) {
                        this.blossomFormError = 'Network error: ' + e.message;
                    }
                },

                confirmDeleteBlossom(blossom) {
                    this.deleteBlossomTarget = blossom;
                },

                async deleteBlossom() {
                    if (!this.deleteBlossomTarget) return;
                    try {
                        const res = await fetch(`/api/blossoms/${this.deleteBlossomTarget.id}`, { method: 'DELETE' });
                        if (res.ok || res.status === 204) {
                            this.deleteBlossomTarget = null;
                            await this.fetchBlossoms();
                            await this.fetchStatus();
                            if (this.currentView === 'blossomForm') {
                                this.currentView = 'blossomList';
                            }
                        } else if (res.status === 401) {
                            window.location.href = '/';
                        } else {
                            alert('Delete failed: ' + await res.text());
                        }
                    } catch (e) {
                        alert('Network error: ' + e.message);
                    }
                },

                // ---- Blossom Media ----

                async showBlossomMedia(blossom) {
                    this.blossomMediaServer = blossom;
                    this.blossomMediaId = blossom.id;
                    this.blossomMediaItems = [];
                    this.uploadProgress = '';
                    this.currentView = 'blossomMedia';
                    await this.fetchBlossomMedia();
                },

                async fetchBlossomMedia() {
                    try {
                        const res = await fetch(`/api/blossoms/${this.blossomMediaId}/media`);
                        if (res.ok) {
                            this.blossomMediaItems = await res.json();
                        }
                    } catch (e) { console.error('Failed to fetch media', e); }
                },

                async uploadMedia() {
                    const input = this.$refs.blossomFileInput;
                    if (!input || !input.files.length) return;

                    this.uploadProgress = `Uploading ${input.files.length} file(s)...`;
                    let uploaded = 0;

                    for (const file of input.files) {
                        const formData = new FormData();
                        formData.append('file', file);
                        try {
                            const res = await fetch(`/api/blossoms/${this.blossomMediaId}/media`, {
                                method: 'POST',
                                body: formData,
                            });
                            if (res.ok) {
                                uploaded++;
                            } else {
                                const err = await res.text();
                                this.uploadProgress = `Error uploading ${file.name}: ${err}`;
                                return;
                            }
                        } catch (e) {
                            this.uploadProgress = `Error: ${e.message}`;
                            return;
                        }
                    }

                    this.uploadProgress = `Uploaded ${uploaded} file(s).`;
                    input.value = '';
                    await this.fetchBlossomMedia();
                    setTimeout(() => { this.uploadProgress = ''; }, 3000);
                },

                async deleteMedia(sha256) {
                    try {
                        const res = await fetch(`/api/blossoms/${this.blossomMediaId}/media/${sha256}`, { method: 'DELETE' });
                        if (res.ok || res.status === 204) {
                            await this.fetchBlossomMedia();
                        } else {
                            alert('Delete failed: ' + await res.text());
                        }
                    } catch (e) {
                        alert('Network error: ' + e.message);
                    }
                },

                formatSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / 1048576).toFixed(1) + ' MB';
                },

                async logout() {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/';
                }
            };
        }
    </script>
</body>
</html>
